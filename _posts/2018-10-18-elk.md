---
layout: post
title: 'elk部署'
date: 2018-10-18
author: 邬晨
color: rgb(255,210,32)
cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-banner.png'
tags: elk
---

> 记录一下elk的安装.

# ELK日志平台部署文档

## 目录 

- [为什么会有这个文章](#为什么会有这个文章)
  - [关于](#关于)
  - [声明](#声明)
- [环境准备](#环境准备)
  - [系统环境](#系统环境)
  - [软件版本,路径](#软件版本,路径)
- [环境部署](#环境部署)
  - [初始化](#初始化)
  - [JDK安装](#安装JDK)
  - [elasticsearch安装](#elasticsearch安装)
  - [logstash安装](#logstash安装)
  - [zookeeper安装](#zookeeper安装)
  - [kafka安装](#kafka安装)
  - [kibana安装](#kibana安装)
- [使用帮助](#使用帮助)

## 为什么会有这个文章
###  关于
为了日志可视化，提高工作效率

### 声明

文档与官方文档有冲突，请与官方文档为准
## 环境准备
### 系统环境
系统：centos7.2

|   Name   | 公网IP |    内网IP     |          软件          |
| :------: | :----: | :-----------: | :--------------------: |
| es-node1 |  XXXX  | 10.46.226.77  |    jdk,es,zk,kafka     |
| es-node2 |  XXXX  | 10.26.91.126  |    jdk,es,zk,kafka     |
| es-node3 |  XXXX  |  10.27.0.39   | jdk,es,zk,kafka,kibana |
| logstash |  XXXX  | 10.80.153.218 |      jdk,logstash      |
|  kibana  |  XXXX  |  10.27.0.39   | jdk,es,zk,kafka,kibana |


内核：3.10

Yum源：清华大学开源镜像站
### 软件版本，路径

| 软件          | 版本       | 路径            |
| ------------- | ---------- | --------------- |
| JDK           | 1.8        | /usr/local/jdk  |
| elasticsearch | 6.2.2      | /usr/local/elk/ |
| logstash      | 6.2.2      | /usr/local/elk/ |
| kibana        | 6.2.2      | /usr/local/elk/ |
| zookeeper     | 3.4.11     | /usr/local/elk/ |
| kafka         | 2.12-1.0.1 | /usr/local/elk/ |

## 环境部署
### 初始化
更改hostname

关闭防火墙(部署完成之后打开相应端口)，关闭selinux，

挂载数据盘到/data/目录

四台节点相互写好/etc/hosts

### 安装JDK

>### 首先把软件包上传到四个节点
>### 以下操作在四台节点都要操作


```shell
tar -xf jdk-8u162-linux-x64.tar.gz
mv jdk1.8.0_162/ /usr/local/jdk

vim /etc/profile
#最后添加
export JAVA_HOME=/usr/local/jdk
export JAVA_BIN=/usr/local/bin/jdk
export PATH=$PATH:$JAVA_HOME/bin
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export JAVA_HOME JAVA_BIN PATH CLASSPATH

source /etc/profile
java -version
java version "1.8.0_162"
Java(TM) SE Runtime Environment (build 1.8.0_162-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)
```


```shell
useradd elk
passwd elk
```
### elasticsearch安装

>### 以下操作在三个es节点操作

```shell
vim /etc/security/limits.conf 
#在最后添加
* soft nproc 65536 
* hard nproc 65536
* soft nofile 65536
* hard nofile 65536
mkdir /usr/local/elk
tar -xf elasticsearch-6.2.2.tar.gz  -C /usr/local/elk/
```


```shell
echo "ulimit -SHn 65536" >> /etc/profile
ource /etc/profile
vim /etc/sysctl.conf
vm.max_map_count = 262144
vm.swappiness = 1
sysctl -p

mkdir /usr/local/elk
mkdir /data/{data,logs} -p     #创建es数据和日志目录
tar -xf elasticsearch-6.2.2.tar.gz  -C /usr/local/elk/

chown elk:elk /data/ -R
chown elk:elk  /usr/local/elk -R

vim /usr/local/elk/elasticsearch-6.6.2/config/jvm.options
#调整JVM参数，适当而为，但不要超过31G
-Xms4g
-Xmx4g
```

>### 每个节点只有node.name与network.host不同，其余都相同

```shell
vim /usr/local/elk/elasticsearch-6.2.2/config/elasticsearch.yml
cluster.name: cluster-es                  #自定义集群名，相同集群内节点设置相同集群名
node.name: es-node1                       #自定义节点名，建议统一采用节点hostname
node.master: true                         #是否能当选master
node.data: true                           #是否能当选node
path.data: /data/data/                    #data存储路径
path.logs: /data/logs/                    #logs存储路径
index.number_of_shards: 5                 #设置默认索引分片个数，默认为5片。
index.number_of_replicas: 1               #设置默认索引副本个数，默认为1个副本。
bootstrap.system_call_filter: false       #系统调用过滤器，建议禁用该项检查，因为很多检查项需要Linux 3.5以上的内核。否则会报错误
#http.cors.enabled: true                  #head必须
#http.cors.allow-origin: "*"              #head必须
